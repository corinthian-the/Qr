<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CCBA Near Miss Reporting</title>
<style>
:root{
  --bg:#f5f7fb;
  --card:#fff;
  --accent:#d00000;
  --muted:#555;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  color:#111;
  background:var(--bg);
}
.wrap{
  max-width:760px;
  margin:20px auto;
  background:var(--card);
  padding:20px;
  border-radius:10px;
  box-shadow:0 8px 30px rgba(12,20,40,0.06);
}
.logo-box{
  width:100%;
  text-align:center;
  padding-bottom:12px;
  border-bottom:3px solid #e5e5e5;
  margin-bottom:16px;
}
.logo-box img{
  width:100%;
  max-width:420px;
  height:auto;
}
.qr-code{
  text-align:center;
  margin-bottom:16px;
}
.qr-code img{
  width:220px;
  height:220px;
  max-width:100%;
}
h1{font-size:22px;margin:6px 0 8px}
.info-block{
  background:#fafafa;
  border-left:4px solid var(--accent);
  padding:12px;
  font-size:14px;
  margin-bottom:18px;
  line-height:1.45;
}
label{
  font-weight:600;
  font-size:14px;
  margin-top:14px;
  display:block;
}
input[type=text],
input[type=time],
input[type=date],
textarea,
select{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #dfe6ef;
  margin-top:6px;
  font-size:14px;
}
textarea{min-height:120px;resize:vertical}
.row{display:flex;gap:12px}
.row>*{flex:1}
fieldset{
  border:1px solid #e6eef8;
  border-radius:8px;
  padding:12px;
  margin-top:14px;
}
legend{font-weight:700;padding:0 4px}
.checkbox-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:8px;
  margin-top:8px;
  font-size:14px;
}
button{
  cursor:pointer;
  border:none;
  border-radius:10px;
  padding:12px 16px;
  font-size:15px;
  font-weight:700;
}
.submit-btn{
  background:var(--accent);
  color:white;
}
.secondary{
  background:#f0f4ff;
  color:#004aad;
  border:1px solid #bcd4ff;
}
.actions{display:flex;gap:12px;margin-top:20px;flex-wrap:wrap}
.small{font-size:13px;color:var(--muted);margin-top:8px}
.note{font-size:13px;color:var(--muted);margin-top:14px}
@media(max-width:500px){.row{flex-direction:column}}
</style>
</head>
<body>
<main class="wrap">

  <!-- Logo (uploaded file) -->
  <div class="logo-box" aria-hidden="false">
    <img src="CCBA-Logo-Horizontal-1024x295.png" alt="CCBA Logo">
  </div>

  <!-- QR code (embedded as Base64, opens the form directly) -->
  <div class="qr-code" aria-hidden="false">
    <img
      src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAE8UlEQVR4Xu3dMW4TQRQF4F1YgYgAhQjgAiAgQgghoGICAgjAgQgghoGAgIQghoGAgAgghkDvdmc5s7szuzO9s7s7u0zfM0uH7qvdXd3d3f39/f39/ff+7juu+7u7u7v7e3t7e39/f392dnd3d3dXd3d1fX19fX9/X19fX1b49tvvh9fX19fX9/X19fX19/X19dW8mP77KqH5b1Wx+X9Vsfh/VbH5f1Wx+H9Vsfh/VbH5f1Wx+H9Vsfh/VbH5f1Wx+H9Vsfh/VbH5f1Wx+H9Vsfh/VbH5f1Wx+H9Vsfh/VbH5f1Wx+H9VsT9vtybn+9Vsb5v1Wx/m9VsX5v1Wx/m9VsX5v1Wx/m9VsX5v1Wx/m9VsX5v1Wx/m9VsX5v1Wx/m9VsX5v1Wx/m9VsX5v1Wx/m9VsX5v1Wx/m9VsT6fvFef32q2P87qti/O6rY/zuq2L87qti/O6rY/zuq2L87qti/O6rY/zuq2L87qti/O6rY/zurYvzuq2L87qti/O6rY/zurYvzuq2L87qti/O6rY/zuq2L87qti/O6rY/zuq2L8/puO7v7e3t7e3v7+/v7+/v7+/v7+/v7+/39/f39/f39/f39/f39/f39/f39fV3d3d3dXd3d3d3d/d93df/6yE8xQAAAAASUVORK5CYII="
      alt="Scan QR to open the Near Miss Form">
    <p>Scan to open the Near Miss Form</p>
  </div>

  <!-- Document info -->
  <div class="info-block" role="region" aria-label="Document information">
    <strong>Near Miss Reporting Form</strong><br>
    Number: <strong>DOC.F.3746</strong><br>
    Doc Owner: <strong>Teresia Kigera</strong><br>
    Revision: <strong>0</strong><br>
    Status: <strong>Published</strong><br>
    Effective Date: <strong>2024-07-16</strong><br>
    Page: <strong>1 of 1</strong><br><br>
    A near miss is defined as an unplanned event that did not result in injury, illness, or damage,
    but had the potential to do so.<br><br>
    Everyone is responsible for reporting and correcting potential hazards immediately.
  </div>

  <!-- Form -->
  <form id="nearMissForm" aria-label="Near miss reporting form">
    <input type="hidden" id="ts" name="Timestamp" value="">

    <label>Date of Near Miss</label>
    <input type="date" name="Date" required>

    <div class="row">
      <div>
        <label>Time of Near Miss</label>
        <input type="time" name="Time" required>
      </div>
      <div>
        <label>Location of Near Miss</label>
        <input type="text" name="Location" placeholder="Address / Area / Site" required>
      </div>
    </div>

    <fieldset>
      <legend>Category (Select all that apply)</legend>
      <div class="checkbox-grid">
        <label><input type="checkbox" name="Category" value="Fall from height"> Fall from height</label>
        <label><input type="checkbox" name="Category" value="Trip/Fall same level"> Trip / fall on same level</label>
        <label><input type="checkbox" name="Category" value="Fall from equipment"> Fall from equipment</label>
        <label><input type="checkbox" name="Category" value="Hazardous Manual Handling"> Hazardous Manual Handling</label>
        <label><input type="checkbox" name="Category" value="Electric Shock"> Electric Shock</label>
        <label><input type="checkbox" name="Category" value="Caught between/underneath"> Caught between/underneath</label>
        <label><input type="checkbox" name="Category" value="Hazardous Substance"> Hazardous Substance</label>
        <label><input type="checkbox" name="Category" value="Falling object"> Falling object</label>
        <label><input type="checkbox" name="Category" value="Other"> Other (specify below)</label>
      </div>
    </fieldset>

    <label>If 'Other', specify</label>
    <input type="text" name="Other Category">

    <label>Describe how the Near Miss occurred</label>
    <textarea name="Description" required></textarea>

    <label>Describe what led up to and caused the Near Miss</label>
    <textarea name="Causes" required></textarea>

    <label>Photo(s) (optional)</label>
    <input type="file" name="Photos" multiple accept="image/*">

    <label>Safety suggestions to prevent recurrence</label>
    <textarea name="Suggestions"></textarea>

    <div class="row">
      <div>
        <label>Name (optional)</label>
        <input type="text" name="Reporter Name">
      </div>
      <div>
        <label>Signature (optional)</label>
        <input type="text" name="Signature">
      </div>
    </div>

    <div class="actions">
      <button class="submit-btn" type="submit" aria-label="Submit report">Submit Near Miss Report</button>
      <button type="button" class="secondary" id="geoBtn">Add GPS Location</button>
    </div>
    <div id="status" class="small" role="status" aria-live="polite"></div>
    <p class="note">Report will be emailed to TKigera@ccbagroup.com and stored in Google Sheets.</p>
  </form>
</main>

<script>
(function(){
  const SHEETS_URL = "https://script.google.com/macros/s/AKfycby1mxFl5ILuBwz0U5ialMGYX-Fjg6U9U0vvnVSvqQQYhy4YUgZbNir44Ij2Du8lsSk/exec";
  const EMAIL_ENDPOINT = "https://formsubmit.co/ajax/TKigera@ccbagroup.com";

  const tsInput = document.getElementById('ts');
  const status = document.getElementById('status');
  const form = document.getElementById('nearMissForm');
  const nextUrl = window.location.href + "?thankyou=1";

  function setTimestamp(){ tsInput.value = new Date().toISOString(); }
  setTimestamp();

  document.getElementById('geoBtn').onclick = function(){
    if(!navigator.geolocation){ status.textContent = "GPS not supported."; return; }
    status.textContent = "Requesting GPS...";
    navigator.geolocation.getCurrentPosition((pos)=>{
      const lat = pos.coords.latitude.toFixed(6);
      const lon = pos.coords.longitude.toFixed(6);
      const loc = form.querySelector("input[name='Location']");
      loc.value += (loc.value ? " — " : "") + `Lat:${lat}, Lon:${lon}`;
      status.textContent = "GPS added.";
    }, (err)=>{
      status.textContent = "GPS access denied.";
    }, {timeout:10000});
  };

  function collectForm(form){
    const fd = new FormData(form);
    const obj = {};
    for (const [k, v] of fd.entries()){
      if (v instanceof File && v.name){
        if (!obj[k]) obj[k] = v.name;
        else if (Array.isArray(obj[k])) obj[k].push(v.name);
        else obj[k] = [obj[k], v.name];
      } else {
        if (obj[k]){
          if (Array.isArray(obj[k])) obj[k].push(v);
          else obj[k] = [obj[k], v];
        } else obj[k] = v;
      }
    }
    obj.Timestamp = tsInput.value || new Date().toISOString();
    return obj;
  }

  form.addEventListener('submit', function(e){
    e.preventDefault();
    setTimestamp();
    status.textContent = "Submitting...";

    const formData = new FormData(form);
    const payload = collectForm(form);

    fetch(SHEETS_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    })
    .then(r => r.json().catch(()=>({})))
    .catch(err => { console.warn("Google Sheets submission failed:", err); });

    const emailForm = new FormData();
    for (const [k, v] of formData.entries()) emailForm.append(k, v);
    emailForm.append("_subject", "Near Miss Report");
    emailForm.append("_captcha", "false");
    emailForm.append("_next", nextUrl);

    fetch(EMAIL_ENDPOINT, {
      method: "POST",
      body: emailForm
    })
    .then(r => r.json())
    .then(r => {
      window.location.href = nextUrl;
    })
    .catch(err => {
      alert("Email sending failed; your report may still be saved. Please contact safety team directly.");
      window.location.href = nextUrl;
    });

  });

  if (new URLSearchParams(window.location.search).get("thankyou")){
    document.body.innerHTML = `
      <main class="wrap" style="text-align:center;padding:40px;">
        <h1 style="color:var(--accent);">Thank you — Report Submitted</h1>
        <p style="font-size:16px; color:#333">Your near-miss report has been received. The Safety Team will review it shortly.</p>
        <p style="margin-top:20px;"><a href="${window.location.origin + window.location.pathname}" style="color:#004aad;text-decoration:underline">Submit another report</a></p>
      </main>`;
  }

})();
</script>
</body>
</html>
